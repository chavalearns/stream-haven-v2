<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idea Vault - Stream Haven V2</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
</head>
<body class="no-sidebar">
    <nav class="top-nav">
        <div class="nav-brand">
            <h2>ðŸŒ™ Stream Haven</h2>
        </div>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Dashboard</a>
            <a href="planner.html" class="nav-link">Streams</a>
            <a href="content-planner.html" class="nav-link">Content</a>
            <a href="calendar.html" class="nav-link">Calendar</a>
            <a href="goals.html" class="nav-link">Goals</a>
            <a href="game.html" class="nav-link">Game</a>
            <a href="ideas.html" class="nav-link active">Ideas</a>
            <a href="growth.html" class="nav-link">Growth</a>
            <a href="links.html" class="nav-link">Links</a>
            <a href="themes.html" class="nav-link">Themes</a>
            <a href="accounts.html" class="nav-link">Accounts</a>
            <a href="settings.html" class="nav-link">Settings</a>
        </div>
        <div class="nav-user">
            <span class="account-name">Account</span>
            <div id="userEmail"></div>
        </div>
    </nav>

    <main class="main-content-full">
        <div class="page-header mb-3">
            <h1>Idea Vault</h1>
            <p>Store and manage your creative content ideas</p>
        </div>

        <!-- Add Idea Form -->
        <div class="card mb-3">
            <div class="widget-header">
                <h3 class="widget-title">Add New Idea</h3>
            </div>
            <form id="addIdeaForm">
                <div class="form-group">
                    <label class="form-label" for="ideaText">Idea Description</label>
                    <textarea id="ideaText" class="form-textarea" placeholder="Enter your content idea" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn">Add Idea</button>
            </form>
        </div>

        <!-- Filter Tabs -->
        <div class="card mb-3">
            <div class="widget-header">
                <h3 class="widget-title">Filter Ideas</h3>
            </div>
            <div class="filter-tabs">
                <button class="btn btn-secondary active" onclick="filterIdeas('all')">All Ideas</button>
                <button class="btn btn-secondary" onclick="filterIdeas('unused')">Unused</button>
                <button class="btn btn-secondary" onclick="filterIdeas('used')">Used</button>
            </div>
        </div>

        <!-- Ideas List -->
        <div class="card">
            <div class="widget-header">
                <h3 class="widget-title">Your Ideas</h3>
                <span class="widget-badge" id="ideaCount">0</span>
            </div>
            <div id="ideasList">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ’¡</div>
                    <div class="empty-state-title">No ideas yet</div>
                    <div class="empty-state-text">Add your first idea to build your content vault</div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/sqlite-adapter.js"></script>
    <script src="js/local-auth.js"></script>
    <script src="js/app-config.js"></script>
    <script src="js/data-api.js"></script>
    <script>
        // Ideas state
        let currentFilter = 'all';
        let allIdeas = [];

        // Ideas functions
        async function loadIdeas() {
            try {
                if (!Auth.isAuthenticated()) {
                    return;
                }

                const { data: ideas, error } = SQLiteDB.getAll('ideas', 'user_id = ? AND account_id = ?', [window.currentUser.id, window.currentAccount.id], 'created_at DESC');

                if (error) throw error;

                allIdeas = ideas || [];
                displayFilteredIdeas();

            } catch (error) {
                console.error('Failed to load ideas:', error);
                Utils.showNotification('Failed to load ideas', 'error');
            }
        }

        function displayFilteredIdeas() {
            const filteredIdeas = allIdeas.filter(idea => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'unused') return !idea.used;
                if (currentFilter === 'used') return idea.used;
                return true;
            });

            const ideasList = document.getElementById('ideasList');
            const ideaCount = document.getElementById('ideaCount');
            
            ideaCount.textContent = filteredIdeas.length;

            if (filteredIdeas.length > 0) {
                ideasList.innerHTML = filteredIdeas.map(idea => `
                    <div class="list-item ${idea.used ? 'completed' : ''}">
                        <div class="idea-content">
                            <div class="${idea.used ? 'item-text' : ''}">
                                <strong>${idea.text}</strong>
                                ${idea.used ? '<span class="badge">Used</span>' : ''}
                                <br>
                                <small class="text-secondary">Added ${Utils.formatDate(idea.created_at)}</small>
                            </div>
                        </div>
                        <div class="item-actions">
                            ${!idea.used ? 
                                `<button class="btn btn-success" onclick="markAsUsed('${idea.id}')">Mark as Used</button>` : 
                                `<button class="btn btn-secondary" onclick="markAsUnused('${idea.id}')">Mark as Unused</button>`
                            }
                            <button class="btn btn-danger" onclick="deleteIdea('${idea.id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            } else {
                const emptyMessage = currentFilter === 'used' ? 'No used ideas yet' :
                                  currentFilter === 'unused' ? 'No unused ideas' :
                                  'No ideas yet';
                const emptyIcon = currentFilter === 'used' ? 'âœ…' :
                                 currentFilter === 'unused' ? 'ðŸ’¡' :
                                 'ðŸ’¡';
                const emptyTitle = currentFilter === 'used' ? 'No used ideas' :
                                  currentFilter === 'unused' ? 'No unused ideas' :
                                  'No ideas yet';
                const emptyText = currentFilter === 'used' ? 'Mark some ideas as used to see them here' :
                                currentFilter === 'unused' ? 'All ideas have been used!' :
                                'Add your first idea to build your content vault';

                ideasList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">${emptyIcon}</div>
                        <div class="empty-state-title">${emptyTitle}</div>
                        <div class="empty-state-text">${emptyText}</div>
                    </div>
                `;
            }
        }

        function filterIdeas(filter) {
            currentFilter = filter;
            
            // Update button states
            document.querySelectorAll('.filter-tabs .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayFilteredIdeas();
        }

        // Add new idea
        document.getElementById('addIdeaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const text = document.getElementById('ideaText').value.trim();

            if (!text) {
                Utils.showNotification('Please enter an idea', 'error');
                return;
            }

            try {
                const { data, error } = SQLiteDB.insert('ideas', {
                        user_id: window.currentUser.id,
                        account_id: window.currentAccount.id,
                        text: text,
                        used: false
                    });

                if (error) throw error;

                Utils.showNotification('Idea added successfully!', 'success');
                
                // Reset form
                document.getElementById('addIdeaForm').reset();
                
                // Reload ideas
                await loadIdeas();

            } catch (error) {
                console.error('Failed to add idea:', error);
                Utils.showNotification('Failed to add idea', 'error');
            }
        });

        // Mark idea as used
        async function markAsUsed(ideaId) {
            try {
                const { error } = SQLiteDB.update('ideas', 
                    { used: true }, 
                    'id = ? AND user_id = ?', 
                    [ideaId, window.currentUser.id]
                );

                if (error) throw error;

                Utils.showNotification('Idea marked as used', 'success');
                await loadIdeas();

            } catch (error) {
                console.error('Failed to mark idea as used:', error);
                Utils.showNotification('Failed to mark idea as used', 'error');
            }
        }

        // Mark idea as unused
        async function markAsUnused(ideaId) {
            try {
                const { error } = SQLiteDB.update('ideas', 
                    { used: false }, 
                    'id = ? AND user_id = ?', 
                    [ideaId, window.currentUser.id]
                );

                if (error) throw error;

                Utils.showNotification('Idea marked as unused', 'success');
                await loadIdeas();

            } catch (error) {
                console.error('Failed to mark idea as unused:', error);
                Utils.showNotification('Failed to mark idea as unused', 'error');
            }
        }

        // Delete idea
        async function deleteIdea(ideaId) {
            if (!confirm('Are you sure you want to delete this idea?')) {
                return;
            }

            try {
                const { error } = SQLiteDB.delete('ideas', 'id = ? AND user_id = ?', [ideaId, window.currentUser.id]);

                if (error) throw error;

                Utils.showNotification('Idea deleted successfully', 'success');
                await loadIdeas();

            } catch (error) {
                console.error('Failed to delete idea:', error);
                Utils.showNotification('Failed to delete idea', 'error');
            }
        }

        // Add ideas specific styles
        const ideasStyles = `
            .idea-content {
                flex: 1;
            }
            
            .filter-tabs {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            .filter-tabs .btn {
                flex: 1;
                min-width: 100px;
            }
            
            .filter-tabs .btn.active {
                background: var(--accent);
                color: var(--bg-primary);
            }
            
            .badge {
                background: var(--success);
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 1rem;
                font-size: 0.8rem;
                font-weight: 600;
                margin-left: 0.5rem;
            }
            
            .item-text {
                text-decoration: line-through;
                opacity: 0.7;
            }
        `;

        // Add styles to page
        const styleSheet = document.createElement('style');
        styleSheet.textContent = ideasStyles;
        document.head.appendChild(styleSheet);

        // Load ideas when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            if (await Auth.checkAuth()) {
                await loadIdeas();
            }
        });

        // Reload ideas when account switches
        document.addEventListener('accountSwitched', loadIdeas);

        // Expose functions globally
        window.filterIdeas = filterIdeas;
        window.markAsUsed = markAsUsed;
        window.markAsUnused = markAsUnused;
        window.deleteIdea = deleteIdea;
        window.loadPageData = loadIdeas;
    </script>
</body>
</html>
