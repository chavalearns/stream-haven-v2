<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goals - Stream Haven V2</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
</head>
<body class="no-sidebar">
    <nav class="top-nav">
        <div class="nav-brand">
            <h2>ðŸŒ™ Stream Haven</h2>
        </div>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Dashboard</a>
            <a href="planner.html" class="nav-link">Streams</a>
            <a href="content-planner.html" class="nav-link">Content</a>
            <a href="calendar.html" class="nav-link">Calendar</a>
            <a href="goals.html" class="nav-link active">Goals</a>
            <a href="game.html" class="nav-link">Game</a>
            <a href="ideas.html" class="nav-link">Ideas</a>
            <a href="growth.html" class="nav-link">Growth</a>
            <a href="links.html" class="nav-link">Links</a>
            <a href="themes.html" class="nav-link">Themes</a>
            <a href="accounts.html" class="nav-link">Accounts</a>
            <a href="settings.html" class="nav-link">Settings</a>
        </div>
        <div class="nav-user">
            <span class="account-name">Account</span>
            <div id="userEmail"></div>
        </div>
    </nav>

    <main class="main-content-full">
        <div class="page-header mb-3">
            <h1>Goals Tracker</h1>
            <p>Set and track your streaming goals</p>
        </div>

        <!-- Add Goal Form -->
        <div class="card mb-3">
            <div class="widget-header">
                <h3 class="widget-title">Add New Goal</h3>
            </div>
            <form id="addGoalForm">
                <div class="form-group">
                    <label class="form-label" for="goalText">Goal Description</label>
                    <input type="text" id="goalText" class="form-input" placeholder="Enter your goal" required>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label" for="goalTarget">Target</label>
                        <input type="number" id="goalTarget" class="form-input" placeholder="Target number" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="goalCurrent">Current Progress</label>
                        <input type="number" id="goalCurrent" class="form-input" placeholder="Current progress" min="0" value="0">
                    </div>
                </div>
                <button type="submit" class="btn">Add Goal</button>
            </form>
        </div>

        <!-- Goals List -->
        <div class="card">
            <div class="widget-header">
                <h3 class="widget-title">Active Goals</h3>
                <span class="widget-badge" id="goalCount">0</span>
            </div>
            <div id="goalsList">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸŽ¯</div>
                    <div class="empty-state-title">No goals set</div>
                    <div class="empty-state-text">Set your first goal to start tracking progress</div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/sqlite-adapter.js"></script>
    <script src="js/local-auth.js"></script>
    <script src="js/app-config.js"></script>
    <script src="js/data-api.js"></script>
    <script>
        // Goals functions
        async function loadGoals() {
            try {
                if (!Auth.isAuthenticated()) {
                    return;
                }

                const { data: goals, error } = SQLiteDB.getAll('goals', 'user_id = ? AND account_id = ?', [window.currentUser.id, window.currentAccount.id], 'created_at DESC');

                if (error) throw error;

                const goalsList = document.getElementById('goalsList');
                const goalCount = document.getElementById('goalCount');
                
                goalCount.textContent = goals?.length || 0;

                if (goals && goals.length > 0) {
                    goalsList.innerHTML = goals.map(goal => {
                        const percentage = Utils.calculatePercentage(goal.current, goal.target);
                        const isCompleted = percentage >= 100;
                        
                        return `
                            <div class="list-item ${isCompleted ? 'completed' : ''}">
                                <div class="goal-info">
                                    <div>
                                        <strong>${goal.text}</strong>
                                        ${isCompleted ? '<span class="badge">Completed!</span>' : ''}
                                        <br>
                                        <span class="goal-progress">${goal.current} / ${goal.target}</span>
                                        <br>
                                        <small class="text-secondary">Created ${Utils.formatDate(goal.created_at)}</small>
                                    </div>
                                </div>
                                <div class="goal-progress-section">
                                    <div class="progress-bar mb-2">
                                        <div class="progress-fill" style="width: ${percentage}%"></div>
                                    </div>
                                    <div class="progress-percentage">${percentage}%</div>
                                    <div class="item-actions mt-2">
                                        <div class="inline-update">
                                            <input type="number" 
                                                   class="form-input" 
                                                   value="${goal.current}" 
                                                   min="0" 
                                                   max="${goal.target}"
                                                   onchange="updateGoalProgress('${goal.id}', this.value)"
                                                   style="width: 80px;">
                                            <button class="btn btn-secondary" onclick="updateGoalProgress('${goal.id}', this.previousElementSibling.value)">Update</button>
                                        </div>
                                        <button class="btn btn-danger" onclick="deleteGoal('${goal.id}')">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    goalsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸŽ¯</div>
                            <div class="empty-state-title">No goals set</div>
                            <div class="empty-state-text">Set your first goal to start tracking progress</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load goals:', error);
                Utils.showNotification('Failed to load goals', 'error');
            }
        }

        // Add new goal
        document.getElementById('addGoalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const text = document.getElementById('goalText').value.trim();
            const target = parseInt(document.getElementById('goalTarget').value);
            const current = parseInt(document.getElementById('goalCurrent').value) || 0;

            if (!text || !target) {
                Utils.showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (target <= 0) {
                Utils.showNotification('Target must be greater than 0', 'error');
                return;
            }

            if (current > target) {
                Utils.showNotification('Current progress cannot exceed target', 'error');
                return;
            }

            try {
                const { data, error } = SQLiteDB.insert('goals', {
                        user_id: window.currentUser.id,
                        account_id: window.currentAccount.id,
                        text: text,
                        target: target,
                        current: current
                    });

                if (error) throw error;

                Utils.showNotification('Goal added successfully!', 'success');
                
                // Reset form
                document.getElementById('addGoalForm').reset();
                
                // Reload goals
                await loadGoals();

            } catch (error) {
                console.error('Failed to add goal:', error);
                Utils.showNotification('Failed to add goal', 'error');
            }
        });

        // Update goal progress
        async function updateGoalProgress(goalId, newProgress) {
            try {
                const progress = parseInt(newProgress);
                
                if (isNaN(progress) || progress < 0) {
                    Utils.showNotification('Please enter a valid progress number', 'error');
                    return;
                }

                // Get goal to check target
                const { data: goal, error: fetchError } = SQLiteDB.get('goals', 'id = ? AND user_id = ?', [goalId, window.currentUser.id]);

                if (fetchError) throw fetchError;

                if (progress > goal.target) {
                    Utils.showNotification('Progress cannot exceed target', 'error');
                    return;
                }

                const { error } = SQLiteDB.update('goals', 
                    { current: progress }, 
                    'id = ? AND user_id = ?', 
                    [goalId, window.currentUser.id]
                );

                if (error) throw error;

                const percentage = Utils.calculatePercentage(progress, goal.target);
                if (percentage >= 100) {
                    Utils.showNotification('ðŸŽ‰ Goal completed! Congratulations!', 'success');
                } else {
                    Utils.showNotification('Progress updated', 'success');
                }
                
                await loadGoals();

            } catch (error) {
                console.error('Failed to update goal progress:', error);
                Utils.showNotification('Failed to update goal progress', 'error');
            }
        }

        // Delete goal
        async function deleteGoal(goalId) {
            if (!confirm('Are you sure you want to delete this goal?')) {
                return;
            }

            try {
                const { error } = SQLiteDB.delete('goals', 'id = ? AND user_id = ?', [goalId, window.currentUser.id]);

                if (error) throw error;

                Utils.showNotification('Goal deleted successfully', 'success');
                await loadGoals();

            } catch (error) {
                console.error('Failed to delete goal:', error);
                Utils.showNotification('Failed to delete goal', 'error');
            }
        }

        // Add goals specific styles
        const goalsStyles = `
            .goal-info {
                flex: 1;
            }
            
            .goal-progress-section {
                flex: 1;
                min-width: 200px;
            }
            
            .goal-progress {
                color: var(--accent);
                font-weight: 600;
            }
            
            .progress-percentage {
                text-align: center;
                color: var(--text-secondary);
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }
            
            .inline-update {
                display: flex;
                gap: 0.5rem;
                align-items: center;
                margin-bottom: 0.5rem;
            }
            
            .badge {
                background: var(--success);
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 1rem;
                font-size: 0.8rem;
                font-weight: 600;
                margin-left: 0.5rem;
            }
        `;

        // Add styles to page
        const styleSheet = document.createElement('style');
        styleSheet.textContent = goalsStyles;
        document.head.appendChild(styleSheet);

        // Load goals when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            if (await Auth.checkAuth()) {
                await loadGoals();
            }
        });

        // Reload goals when account switches
        document.addEventListener('accountSwitched', loadGoals);

        // Expose functions globally
        window.updateGoalProgress = updateGoalProgress;
        window.deleteGoal = deleteGoal;
        window.loadPageData = loadGoals;
    </script>
</body>
</html>
