<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounts - Stream Haven V2</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
</head>
<body class="no-sidebar">
    <nav class="top-nav">
        <div class="nav-brand">
            <h2>ðŸŒ™ Stream Haven</h2>
        </div>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Dashboard</a>
            <a href="planner.html" class="nav-link">Streams</a>
            <a href="content-planner.html" class="nav-link">Content</a>
            <a href="calendar.html" class="nav-link">Calendar</a>
            <a href="goals.html" class="nav-link">Goals</a>
            <a href="game.html" class="nav-link">Game</a>
            <a href="ideas.html" class="nav-link">Ideas</a>
            <a href="growth.html" class="nav-link">Growth</a>
            <a href="links.html" class="nav-link">Links</a>
            <a href="themes.html" class="nav-link">Themes</a>
            <a href="accounts.html" class="nav-link active">Accounts</a>
            <a href="settings.html" class="nav-link">Settings</a>
        </div>
        <div class="nav-user">
            <span class="account-name">Account</span>
            <div id="userEmail"></div>
        </div>
    </nav>

    <main class="main-content-full">
        <div class="page-header mb-3">
            <h1>Account Management</h1>
            <p>Create and manage multiple streaming accounts</p>
        </div>

        <!-- Add Account Form -->
        <div class="card mb-3">
            <div class="widget-header">
                <h3 class="widget-title">Create New Account</h3>
            </div>
            <form id="addAccountForm">
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label" for="accountName">Account Name</label>
                        <input type="text" id="accountName" class="form-input" placeholder="Enter account name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="accountColor">Color</label>
                        <input type="color" id="accountColor" class="form-input" value="#7c3aed">
                    </div>
                </div>
                <button type="submit" class="btn">Create Account</button>
            </form>
        </div>

        <!-- Accounts List -->
        <div class="card">
            <div class="widget-header">
                <h3 class="widget-title">Your Accounts</h3>
                <span class="widget-badge" id="accountCount">0</span>
            </div>
            <div id="accountsList">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ‘¥</div>
                    <div class="empty-state-title">No accounts yet</div>
                    <div class="empty-state-text">Create your first account to get started</div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/sqlite-adapter.js"></script>
    <script src="js/local-auth.js"></script>
    <script src="js/app-config.js"></script>
    <script src="js/data-api.js"></script>
    <script>
        // Accounts page specific functions
        async function loadAccounts() {
            try {
                if (!Auth.isAuthenticated()) {
                    return;
                }

                const { data: accounts, error } = SQLiteDB.getAll('accounts', 'user_id = ?', [window.currentUser.id], 'created_at ASC');

                if (error) throw error;

                const accountsList = document.getElementById('accountsList');
                const accountCount = document.getElementById('accountCount');
                
                accountCount.textContent = accounts?.length || 0;

                if (accounts && accounts.length > 0) {
                    accountsList.innerHTML = accounts.map(account => `
                        <div class="list-item ${account.id === window.currentAccount?.id ? 'active' : ''}">
                            <div class="account-info">
                                <span class="account-color" style="background-color: ${account.color}"></span>
                                <div>
                                    <strong>${account.name}</strong>
                                    ${account.id === window.currentAccount?.id ? '<span class="badge">Active</span>' : ''}
                                    <br>
                                    <small class="text-secondary">Created ${Utils.formatDate(account.created_at)}</small>
                                </div>
                            </div>
                            <div class="item-actions">
                                ${account.id !== window.currentAccount?.id ? 
                                    `<button class="btn btn-secondary" onclick="switchToAccount('${account.id}')">Switch</button>` : 
                                    ''
                                }
                                ${accounts.length > 1 ? 
                                    `<button class="btn btn-danger" onclick="deleteAccount('${account.id}')">Delete</button>` : 
                                    ''
                                }
                            </div>
                        </div>
                    `).join('');
                } else {
                    accountsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ‘¥</div>
                            <div class="empty-state-title">No accounts yet</div>
                            <div class="empty-state-text">Create your first account to get started</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load accounts:', error);
                Utils.showNotification('Failed to load accounts', 'error');
            }
        }

        // Add new account
        document.getElementById('addAccountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('accountName').value.trim();
            const color = document.getElementById('accountColor').value;

            if (!name) {
                Utils.showNotification('Please enter an account name', 'error');
                return;
            }

            try {
                // Check account limit
                const { data: existingAccounts, error: countError } = SQLiteDB.getAll('accounts', 'user_id = ?', [window.currentUser.id]);

                if (countError) throw countError;

                if (existingAccounts.length >= APP_CONFIG.MAX_ACCOUNTS) {
                    Utils.showNotification(`Maximum ${APP_CONFIG.MAX_ACCOUNTS} accounts allowed`, 'error');
                    return;
                }

                // Create account
                const { data, error } = SQLiteDB.insert('accounts', {
                    user_id: window.currentUser.id,
                    name: name,
                    color: color
                });

                if (error) throw error;

                Utils.showNotification('Account created successfully!', 'success');
                
                // Reset form
                document.getElementById('addAccountForm').reset();
                document.getElementById('accountColor').value = APP_CONFIG.DEFAULT_ACCOUNT_COLOR;
                
                // Reload accounts
                await loadAccounts();

            } catch (error) {
                console.error('Failed to create account:', error);
                Utils.showNotification('Failed to create account', 'error');
            }
        });

        // Switch to account
        async function switchToAccount(accountId) {
            try {
                await Auth.switchAccount(accountId);
                await loadAccounts();
            } catch (error) {
                console.error('Failed to switch account:', error);
            }
        }

        // Delete account
        async function deleteAccount(accountId) {
            if (!confirm('Are you sure you want to delete this account? All data will be permanently deleted.')) {
                return;
            }

            try {
                // Check if it's the current account
                if (accountId === window.currentAccount?.id) {
                    Utils.showNotification('Cannot delete the active account', 'error');
                    return;
                }

                // Delete account and all related data
                const { error } = SQLiteDB.delete('accounts', 'id = ? AND user_id = ?', [accountId, window.currentUser.id]);

                if (error) throw error;

                Utils.showNotification('Account deleted successfully', 'success');
                await loadAccounts();

            } catch (error) {
                console.error('Failed to delete account:', error);
                Utils.showNotification('Failed to delete account', 'error');
            }
        }

        // Load accounts when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            if (await Auth.checkAuth()) {
                await loadAccounts();
            }
        });

        // Reload accounts when account switches
        document.addEventListener('accountSwitched', loadAccounts);

        // Expose functions globally
        window.switchToAccount = switchToAccount;
        window.deleteAccount = deleteAccount;
        window.loadPageData = loadAccounts;
    </script>
</body>
</html>
